<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打卡网站功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>打卡网站功能测试</h1>
    
    <div class="test-section">
        <h2>1. 任务数据结构测试</h2>
        <button onclick="testTaskGroups()">测试任务组数据</button>
        <div id="taskGroupsResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 进度圆环功能测试</h2>
        <button onclick="testProgressCircle()">测试进度圆环</button>
        <div id="progressResult"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 连续打卡功能测试</h2>
        <button onclick="testStreakCalculation()">测试连续打卡计算</button>
        <div id="streakResult"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 历史记录功能测试</h2>
        <button onclick="testHistoryFunction()">测试历史记录</button>
        <div id="historyResult"></div>
    </div>
    
    <div class="test-section">
        <h2>5. 统计功能测试</h2>
        <button onclick="testStatsFunction()">测试统计功能</button>
        <div id="statsResult"></div>
    </div>

    <script src="app.js"></script>
    <script>
        function showResult(elementId, message, isPass) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${isPass ? 'pass' : 'fail'}">${message}</div>`;
        }

        function testTaskGroups() {
            try {
                // 检查任务组是否正确定义
                if (!taskGroups || !Array.isArray(taskGroups)) {
                    throw new Error('taskGroups 未定义或不是数组');
                }
                
                if (taskGroups.length === 0) {
                    throw new Error('taskGroups 为空');
                }
                
                let totalTasks = 0;
                taskGroups.forEach((group, index) => {
                    if (!group.title || !group.tasks || !Array.isArray(group.tasks)) {
                        throw new Error(`任务组 ${index} 结构不正确`);
                    }
                    totalTasks += group.tasks.length;
                });
                
                showResult('taskGroupsResult', 
                    `✓ 任务组数据正常：${taskGroups.length} 个组，共 ${totalTasks} 个任务`, true);
            } catch (error) {
                showResult('taskGroupsResult', `✗ 任务组数据错误：${error.message}`, false);
            }
        }

        function testProgressCircle() {
            try {
                // 模拟一些完成的任务
                const originalTasks = { ...appState.completedTasks };
                appState.completedTasks = { 'dumbbell': true, 'read': true };
                
                updateProgress();
                
                const progressPercent = document.getElementById('progressPercent');
                const completedCount = document.getElementById('completedCount');
                const totalCount = document.getElementById('totalCount');
                
                if (!progressPercent || !completedCount || !totalCount) {
                    throw new Error('进度显示元素未找到');
                }
                
                const percent = progressPercent.textContent;
                const completed = completedCount.textContent;
                const total = totalCount.textContent;
                
                // 恢复原始状态
                appState.completedTasks = originalTasks;
                updateProgress();
                
                showResult('progressResult', 
                    `✓ 进度圆环正常：${completed}/${total} (${percent})`, true);
            } catch (error) {
                showResult('progressResult', `✗ 进度圆环错误：${error.message}`, false);
            }
        }

        function testStreakCalculation() {
            try {
                const originalStreak = appState.streak;
                const originalHistory = { ...appState.history };
                
                // 模拟连续打卡数据
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const dayBeforeYesterday = new Date(today);
                dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);
                
                appState.history[formatDateKey(yesterday)] = { 'dumbbell': true };
                appState.history[formatDateKey(dayBeforeYesterday)] = { 'read': true };
                
                calculateStreak();
                
                const streakCount = appState.streak;
                
                // 恢复原始状态
                appState.streak = originalStreak;
                appState.history = originalHistory;
                
                showResult('streakResult', 
                    `✓ 连续打卡计算正常：计算出 ${streakCount} 天连续打卡`, true);
            } catch (error) {
                showResult('streakResult', `✗ 连续打卡计算错误：${error.message}`, false);
            }
        }

        function testHistoryFunction() {
            try {
                const originalDate = currentDisplayDate;
                const originalHistory = { ...appState.history };
                
                // 模拟历史数据
                const testDate = new Date();
                testDate.setDate(testDate.getDate() - 1);
                const testDateKey = formatDateKey(testDate);
                appState.history[testDateKey] = { 'dumbbell': true, 'read': true };
                
                // 切换到历史日期
                currentDisplayDate = new Date(testDate);
                const historyData = getCurrentDateData();
                
                // 恢复原始状态
                currentDisplayDate = originalDate;
                appState.history = originalHistory;
                
                const completedTasks = Object.keys(historyData).filter(key => historyData[key]).length;
                
                showResult('historyResult', 
                    `✓ 历史记录功能正常：能够获取历史数据，${completedTasks} 个已完成任务`, true);
            } catch (error) {
                showResult('historyResult', `✗ 历史记录功能错误：${error.message}`, false);
            }
        }

        function testStatsFunction() {
            try {
                const originalHistory = { ...appState.history };
                const originalTasks = { ...appState.completedTasks };
                
                // 模拟一些统计数据
                appState.history['2024-01-01'] = { 'dumbbell': true };
                appState.history['2024-01-02'] = { 'read': true, 'dumbbell': true };
                appState.completedTasks = { 'calf': true };
                
                const stats = calculateStats();
                
                // 恢复原始状态
                appState.history = originalHistory;
                appState.completedTasks = originalTasks;
                
                if (!stats || typeof stats.totalDays === 'undefined') {
                    throw new Error('统计数据结构不正确');
                }
                
                showResult('statsResult', 
                    `✓ 统计功能正常：总天数 ${stats.totalDays}，完成天数 ${stats.completedDays}，平均完成度 ${stats.averageCompletion.toFixed(1)}%`, true);
            } catch (error) {
                showResult('statsResult', `✗ 统计功能错误：${error.message}`, false);
            }
        }

        // 页面加载后自动运行所有测试
        window.addEventListener('load', function() {
            setTimeout(() => {
                testTaskGroups();
                testProgressCircle();
                testStreakCalculation();
                testHistoryFunction();
                testStatsFunction();
            }, 1000);
        });
    </script>
</body>
</html>
